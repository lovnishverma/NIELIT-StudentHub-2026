<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NIELIT StudentHub - Feed</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <meta name="theme-color" content="#003366">

    <style>
        :root {
            /* NIELIT Theme Colors */
            --primary: #003366;
            --secondary: #FF6B35;
            --accent: #0066CC;
            --background: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --gradient-primary: linear-gradient(135deg, #003366 0%, #0066CC 100%);
            --shadow-sm: 0 2px 8px rgba(0, 51, 102, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 51, 102, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            width: 100%;
        }

        /* Navigation */
        nav.desktop-nav {
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .logo::before { content: 'üéì'; font-size: 1.8rem; }

        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            position: relative;
            transition: 0.3s;
        }
        .nav-link:hover { color: var(--accent); background: rgba(0, 102, 204, 0.05); }
        .nav-link.active { color: var(--accent); font-weight: 700; }
        .nav-link.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 30px; height: 3px; background: var(--accent); border-radius: 3px;
        }

        /* Layout - FIXED OVERFLOW ISSUE */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 80vh;
        }

        .main-layout {
            display: grid;
            /* Critical Fix: minmax(0, 1fr) prevents content from blowing out width */
            grid-template-columns: 250px minmax(0, 1fr) 280px; 
            gap: 2rem;
            align-items: start;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            width: 100%;
            border: 1px solid var(--border);
        }

        .sidebar-card { position: sticky; top: 100px; height: fit-content; }
        .profile-sidebar { text-align: center; background: linear-gradient(135deg, rgba(0, 51, 102, 0.05), rgba(0, 102, 204, 0.05)); border: 2px solid var(--border); }
        .profile-header { position: relative; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border); }

        .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); flex-shrink: 0; background: #ddd; }
        .big-avatar { width: 100px; height: 100px; margin: 0 auto 1rem; border: 4px solid var(--accent); }

        /* Search Bar - REDESIGNED */
        .search-container { margin-bottom: 1.5rem; position: relative; }
        
        .search-wrapper {
            background: white;
            border-radius: 50px;
            padding: 5px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .search-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0, 102, 204, 0.15);
            transform: translateY(-1px);
        }

        .search-icon { font-size: 1.2rem; color: var(--text-secondary); margin-right: 10px; }

        .search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 10px 0;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-primary);
            background: transparent;
        }

        .search-input::placeholder { color: #9ca3af; }

        /* Filters - Matching Categories */
        .filter-scroll-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 1.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .filter-scroll-container::-webkit-scrollbar { display: none; }

        .filter-btn {
            white-space: nowrap;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            background: white;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,102,204,0.2); }

        /* Project Card */
        .project-card { animation: fadeIn 0.5s ease-out; transition: 0.3s; overflow: hidden; }
        .project-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--accent); }
        .project-header { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        
        .project-title { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; line-height: 1.3; }
        .project-description { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.6; word-wrap: break-word; }
        
        .project-image { width: 100%; height: 300px; object-fit: cover; border-radius: 12px; margin: 1rem 0; border: 1px solid var(--border); }

        .project-footer { display: flex; gap: 0.8rem; padding-top: 1rem; border-top: 1px solid var(--border); align-items: center; flex-wrap: wrap; }

        .action-btn {
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            display: flex; align-items: center; gap: 5px; font-weight: 600; padding: 0.5rem 0.8rem;
            border-radius: 8px; font-size: 0.9rem; transition: 0.2s;
        }
        .action-btn:hover, .action-btn.active { color: var(--accent); background: rgba(0, 102, 204, 0.05); }
        .action-btn.active { background: rgba(0, 102, 204, 0.1); }
        
        .tech-badge { margin-left: auto; font-size: 0.8rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600; }

        /* Trending */
        .trending-item { margin-bottom: 1rem; padding: 0.8rem; border-radius: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; display: flex; align-items: center; gap: 10px; }
        .trending-item:hover { background: rgba(0, 102, 204, 0.05); transform: translateX(5px); border-color: var(--accent); }
        
        /* Mobile Specifics */
        .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); justify-content: space-around; padding: 0.8rem 0.5rem; z-index: 1001; border-top: 1px solid var(--border); }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); font-size: 0.7rem; font-weight: 600; padding: 0.3rem; border-radius: 12px; }
        .mobile-nav-item.active { color: var(--accent); background: rgba(0, 102, 204, 0.1); }
        .mobile-nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        .hidden-desktop { display: none; }
        .mobile-trending-list { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none; }
        .mobile-trend-card { min-width: 240px; background: white; padding: 1rem; border-radius: 16px; border: 1px solid var(--border); cursor: pointer; box-shadow: var(--shadow-sm); }

        /* Buttons & Forms */
        .btn-primary { background: var(--gradient-primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4); }
        .btn-secondary { background: #F3F4F6; color: #1A1A1A; border: none; padding: 0.8rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-ghost { background: transparent; color: #6B7280; border: none; padding: 0.5rem 1rem; cursor: pointer; }
        
        .form-input { width: 100%; padding: 0.8rem; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; margin-bottom: 1rem; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 20px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        
        /* Utils */
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .loading-spinner { font-size: 3rem; animation: spin 2s linear infinite; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Search Results Styles */
        .search-result-card { background: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: 0.2s; }
        .search-result-card:hover { border-color: var(--accent); transform: translateX(5px); }
        .search-icon-placeholder { width: 40px; height: 40px; background: rgba(0, 102, 204, 0.1); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }

        /* Responsive Breakpoints */
        @media (max-width: 1200px) {
            .main-layout { 
                grid-template-columns: 240px 1fr; /* Hide right sidebar on medium screens */
            }
            .right-sidebar { display: none; }
        }

        @media (max-width: 968px) {
            .main-layout { display: flex; flex-direction: column; gap: 1.5rem; }
            .sidebar-card, .nav-links { display: none; }
            .mobile-bottom-nav, .hidden-desktop { display: flex; }
            .hidden-desktop { flex-direction: column; width: 100%; }
            .container { padding: 1rem; padding-bottom: 100px; }
            .project-image { height: 200px; }
            .search-wrapper { border-radius: 12px; } /* Less round on mobile */
        }
    </style>
</head>

<body>

    <div id="loginPage" class="auth-page">
        <div class="auth-box">
            <img src="logo.png" alt="StudentHub" style="width: 150px; height: auto; margin-bottom: 1rem;">
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">NIELIT Ropar</p>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" class="form-input" required placeholder="student@nielit.gov.in"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPass" class="form-input" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Log In</button>
            </form>
            <p style="margin-top: 1.5rem;">No account? <a href="#" onclick="toggleAuth('signup')" style="color: var(--accent); font-weight: 600;">Sign up</a></p>
        </div>
    </div>

    <div id="signupPage" class="auth-page hidden">
        <div class="auth-box">
            <h2 style="margin-bottom: 0.5rem;">Create Account</h2>
            <form onsubmit="handleSignup(event)">
                <div class="form-group"><label>Profile Pic</label><input type="file" id="signupPic" class="form-input" accept="image/*"></div>
                <div class="form-group"><label>Name</label><input type="text" id="signupName" class="form-input" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="signupEmail" class="form-input" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="signupPass" class="form-input" required></div>
                <div class="form-group"><label>Stream</label><input type="text" id="signupMajor" class="form-input" placeholder="e.g. CSE"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
            </form>
            <p style="margin-top: 1rem;"><a href="#" onclick="toggleAuth('login')">Back to Login</a></p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="desktop-nav">
            <div class="nav-container">
                <a href="index.html" class="logo"><img src="logo.png" style="height: 40px;"> StudentHub</a>
                <div class="nav-links">
                    <a href="#" onclick="showSection('feed'); return false;" class="nav-link active">Feed</a>
                    <a href="index.html" class="nav-link">Profiles</a>
                    <button class="btn btn-primary" onclick="openModal('project')">üìù Post Project</button>
                    <button class="btn btn-ghost" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="main-layout">
                <aside class="sidebar-card">
                    <div class="card profile-sidebar">
                        <div class="profile-header">
                            <img id="sideAvatar" src="" class="avatar big-avatar">
                            <h3 id="sideName" style="margin-bottom: 0.25rem;">User</h3>
                            <p id="sideMajor" style="color: var(--text-secondary); font-size: 0.9rem;">Student</p>
                        </div>
                        <button class="btn btn-secondary" onclick="openMyProfilePage()" style="width: 100%; margin-bottom: 0.75rem;">üìÅ My Projects</button>
                        <button class="btn btn-ghost" onclick="openModal('editProfile')" style="width: 100%">‚úèÔ∏è Edit Profile</button>
                    </div>
                </aside>

                <main>
                    <div class="mobile-trending-container hidden-desktop">
                        <h3 style="margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">üî• Trending Now</h3>
                        <div id="mobileTrendingList" class="mobile-trending-list">
                            <div class="loading" style="padding: 1rem; width:100%;">‚è≥</div>
                        </div>
                    </div>

                    <div class="search-container">
                        <div class="search-wrapper">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="searchInput" class="search-input" placeholder="Search projects, technologies..." onkeyup="handleSearch(this.value)">
                        </div>
                    </div>

                    <div id="categoryFilters" class="filter-scroll-container"></div>

                    <div id="projectsList">
                        <div class="loading"><div class="loading-spinner">‚è≥</div><p>Loading...</p></div>
                    </div>
                </main>

                <aside class="right-sidebar">
                    <div class="card">
                        <h3 style="margin-bottom: 1rem;">üî• Trending</h3>
                        <div id="trendingList"></div>
                    </div>
                </aside>
            </div>
        </div>

        <nav class="mobile-bottom-nav">
            <a href="#" onclick="showSection('feed'); return false;" class="mobile-nav-item active"><span class="mobile-nav-icon">üè†</span><span>Feed</span></a>
            <a href="index.html" class="mobile-nav-item"><span class="mobile-nav-icon">üë•</span><span>Profiles</span></a>
            <a href="#" onclick="openModal('project'); return false;" class="mobile-nav-item"><span class="mobile-nav-icon">‚ûï</span><span>Post</span></a>
            <a href="#" onclick="openMyProfile(); return false;" class="mobile-nav-item"><span class="mobile-nav-icon">üë§</span><span>Me</span></a>
        </nav>
    </div>

    <div id="userMenuModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header"><h2>Menu</h2><button class="modal-close" onclick="closeModal('userMenu')">&times;</button></div>
            <img id="menuAvatar" src="" class="avatar big-avatar">
            <h3 id="menuName">User</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="openMyProfilePage()">üìÅ My Projects</button>
                <button class="btn btn-primary" onclick="closeModal('userMenu'); openModal('editProfile')">‚úèÔ∏è Edit Profile</button>
                <button class="btn btn-ghost" onclick="logout()" style="color: #ef4444;">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Share Project</h2><button class="modal-close" onclick="closeModal('project')">&times;</button></div>
            <form onsubmit="handlePostProject(event)">
                <div class="form-group"><label>üì∏ Project Image</label><input type="file" id="postImage" class="form-input" accept="image/*"></div>
                <div class="form-group"><label>Project Title</label><input type="text" id="postTitle" class="form-input" required placeholder="My Awesome Project"></div>
                <div class="form-group"><label>Description</label><textarea id="postDesc" class="form-input" rows="4" required placeholder="Describe your project..."></textarea></div>
                <div class="form-group"><label>üîó Link (GitHub/Demo)</label><input type="url" id="postLink" class="form-input" placeholder="https://"></div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="postCategory" class="form-input" style="background: white;"></select>
                </div>
                
                <div class="form-group"><label>Tech Stack</label><input type="text" id="postTech" class="form-input" placeholder="React, Python..."></div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">Post Project</button>
            </form>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Profile</h2><button class="modal-close" onclick="closeModal('editProfile')">&times;</button></div>
            <form onsubmit="handleEditProfile(event)">
                <div class="form-group"><label>New Pic</label><input type="file" id="editPic" class="form-input" accept="image/*"></div>
                <div class="form-group"><label>Name</label><input type="text" id="editName" class="form-input" required></div>
                <div class="form-group"><label>University</label><input type="text" id="editUni" class="form-input"></div>
                <div class="form-group"><label>Major</label><input type="text" id="editMajorInput" class="form-input"></div>
                <div class="form-group"><label>Bio</label><textarea id="editBio" class="form-input" rows="3"></textarea></div>
                <div class="form-group"><label>Resume (PDF)</label><input type="file" id="editResumeFile" class="form-input" accept=".pdf"> <a id="currentResumeLink" href="#" target="_blank" class="hidden" style="font-size:0.8rem;">View Current</a></div>
                <div class="form-group"><label>LinkedIn</label><input type="url" id="editLinked" class="form-input"></div>
                <div class="form-group"><label>GitHub</label><input type="url" id="editGit" class="form-input"></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Save</button>
            </form>
        </div>
    </div>

    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>üí¨ Comments</h3><button class="modal-close" onclick="closeModal('comments')">&times;</button></div>
            <div id="commentsList" style="margin-bottom: 1.5rem; max-height: 400px; overflow-y: auto;"></div>
            <div style="display: flex; gap: 0.75rem;">
                <input type="text" id="commentInput" class="form-input" style="margin-bottom:0;" placeholder="Write a comment...">
                <button onclick="submitComment()" class="btn btn-primary">Post</button>
            </div>
        </div>
    </div>

    <div id="shareProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üì§ Share</h2><button class="modal-close" onclick="closeModal('shareProject')">&times;</button></div>
            <div style="margin-bottom:1.5rem;"><input type="text" id="shareProjectLink" readonly class="form-input" style="font-family:monospace;"><button onclick="copyShareLink()" class="btn btn-primary" id="copyShareBtn" style="width:100%; margin-top:5px;">üìã Copy Link</button></div>
            <div style="display:grid; gap:0.5rem;">
                <button onclick="shareViaWhatsApp()" class="btn btn-secondary">WhatsApp</button>
                <button onclick="shareViaLinkedIn()" class="btn btn-secondary">LinkedIn</button>
                <button onclick="shareViaTwitter()" class="btn btn-secondary">Twitter</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        const SHEET_URL = CONFIG.SHEET_URL;
        const CLOUDINARY_NAME = CONFIG.CLOUDINARY_NAME;
        const CLOUDINARY_PRESET = CONFIG.CLOUDINARY_PRESET;

        // SINGLE SOURCE OF TRUTH FOR CATEGORIES
        const PROJECT_CATEGORIES = [
            "Web Development", "Mobile App", "AI / ML", "Cloud & DevOps", 
            "Data Science", "IoT & Hardware", "Robotics", "Game Development", 
            "AR / VR", "Blockchain", "Cybersecurity", "Other"
        ];

        let currentUser = JSON.parse(localStorage.getItem('studenthub_user'));
        let currentCommentProjectId = null;
        let currentPage = 1;
        let currentSearchTerm = '';
        let hasMoreProjects = true;
        let isLoading = false;
        let searchIndex = [];
        let fuse;
        let searchTimeout = null;

        window.onload = () => {
            if (currentUser) {
                showApp();
                if (localStorage.getItem('openPostModal')) { localStorage.removeItem('openPostModal'); openModal('project'); }
                loadSearchIndex();
            } else { toggleAuth('login'); }
            
            // INJECT CATEGORIES ON LOAD
            populateCategories();
        };

        function populateCategories() {
            // 1. Filter Chips
            const filterContainer = document.getElementById('categoryFilters');
            let filterHtml = `<button onclick="filterCategory(this, 'All')" class="filter-btn active">All</button>`;
            PROJECT_CATEGORIES.forEach(cat => {
                filterHtml += `<button onclick="filterCategory(this, '${cat}')" class="filter-btn">${cat}</button>`;
            });
            filterContainer.innerHTML = filterHtml;

            // 2. Post Project Dropdown
            const select = document.getElementById('postCategory');
            select.innerHTML = PROJECT_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // --- AUTH ---
        function toggleAuth(view) {
            document.getElementById('loginPage').classList.toggle('hidden', view !== 'login');
            document.getElementById('signupPage').classList.toggle('hidden', view !== 'signup');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('sideName').textContent = currentUser.name;
            document.getElementById('sideMajor').textContent = currentUser.major || 'Student';
            document.getElementById('sideAvatar').src = currentUser.profilePicture || 'default-avatar.png';

            // Edit Prefill
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editUni').value = currentUser.university || '';
            document.getElementById('editMajorInput').value = currentUser.major || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editLinked').value = currentUser.linkedin || '';
            document.getElementById('editGit').value = currentUser.github || '';
            if (currentUser.resume) document.getElementById('currentResumeLink').href = currentUser.resume;

            loadProjects();
            fetchTrending();
        }

        async function handleLogin(e) {
            e.preventDefault(); const btn = e.target.querySelector('button'); const orig = btn.textContent; btn.textContent = '...'; btn.disabled = true;
            try {
                const res = await fetch(`${SHEET_URL}?action=login&email=${document.getElementById('loginEmail').value}&password=${document.getElementById('loginPass').value}`);
                const json = await res.json();
                if (json.status === 'success') { currentUser = json.data; localStorage.setItem('studenthub_user', JSON.stringify(currentUser)); showApp(); }
                else { alert(json.data); btn.textContent = orig; btn.disabled = false; }
            } catch (err) { alert('Error'); btn.disabled = false; }
        }

        async function handleSignup(e) {
            e.preventDefault(); const btn = e.target.querySelector('button'); btn.textContent = '...'; btn.disabled = true;
            const file = document.getElementById('signupPic').files[0]; let picUrl = ''; if (file) picUrl = await uploadImage(file);
            const data = { name: document.getElementById('signupName').value, email: document.getElementById('signupEmail').value, password: document.getElementById('signupPass').value, major: document.getElementById('signupMajor').value, profilePicture: picUrl };
            const res = await postData('signup', { data });
            if (res.status === 'success') { currentUser = data; localStorage.setItem('studenthub_user', JSON.stringify(data)); showApp(); }
            else { alert(res.data); btn.disabled = false; }
        }

        function logout() { if(confirm('Logout?')) { localStorage.removeItem('studenthub_user'); location.reload(); } }

        // --- PROJECTS ---
        async function loadProjects(append = false) {
            if (isLoading) return; isLoading = true;
            if (!append) { currentPage = 1; hasMoreProjects = true; }
            try {
                const res = await fetch(`${SHEET_URL}?action=getProjects&page=${currentPage}&userEmail=${encodeURIComponent(currentUser.email)}${currentSearchTerm ? `&searchTerm=${encodeURIComponent(currentSearchTerm)}` : ''}`);
                const json = await res.json();
                if (json.status === 'success') {
                    hasMoreProjects = json.data.hasMore;
                    renderProjects(json.data.items, append);
                }
            } catch (e) { console.error(e); } finally { isLoading = false; }
        }

        async function fetchTrending() {
            try {
                const res = await fetch(`${SHEET_URL}?action=getTrending`);
                const json = await res.json();
                if (json.status === 'success') {
                    const html = json.data.map((p, i) => `<div class="trending-item" onclick="window.location.href='project.html?id=${p.id}'"><span style="font-weight:700;color:var(--accent)">${i+1}</span><div><div style="font-weight:600;font-size:0.9rem">${escapeHtml(p.title)}</div><div style="font-size:0.75rem;color:gray">üëç ${p.upvotes}</div></div></div>`).join('');
                    document.getElementById('trendingList').innerHTML = html;
                    document.getElementById('mobileTrendingList').innerHTML = json.data.map(p => `<div class="mobile-trend-card" onclick="window.location.href='project.html?id=${p.id}'"><div style="font-weight:600;font-size:0.9rem">${escapeHtml(p.title)}</div><div style="font-size:0.75rem">üëç ${p.upvotes}</div></div>`).join('');
                }
            } catch (e) {}
        }

        function renderProjects(list, append) {
            const container = document.getElementById('projectsList');
            if (!append) container.innerHTML = '';
            if (list.length === 0 && !append) { container.innerHTML = '<div class="card" style="text-align:center;padding:2rem;">No projects found.</div>'; return; }
            
            const html = list.map(p => `
                <div class="project-card card">
                    <div class="project-header">
                        <img src="${p.authorPicture || 'default-avatar.png'}" class="avatar">
                        <div style="flex:1;"><div style="font-weight:600;cursor:pointer;color:var(--primary)" onclick="window.location.href='index.html?email=${p.authorEmail}'">${escapeHtml(p.authorName)}</div><div style="font-size:0.8rem;color:gray">${formatDate(p.timestamp)}</div></div>
                    </div>
                    <div class="project-title">${escapeHtml(p.title)}</div>
                    <div class="project-description">${escapeHtml(p.description)}</div>
                    ${p.projectImage ? `<img src="${p.projectImage}" class="project-image" loading="lazy">` : ''}
                    <div class="project-footer">
                        <span style="font-size:0.75rem;background:rgba(0,102,204,0.1);color:var(--accent);padding:4px 10px;border-radius:12px;font-weight:600;">${escapeHtml(p.category || 'Other')}</span>
                        <button class="action-btn ${p.isLiked ? 'active' : ''}" onclick="upvote('${p.id}',this)">üëç <span>${p.upvotes}</span></button>
                        <button class="action-btn" onclick="openComments('${p.id}')">üí¨ <span>${p.commentCount || 0}</span></button>
                        <button class="action-btn" onclick="shareProject('${p.id}','${escapeHtml(p.title).replace(/'/g, "\\'")}')">üì§ Share</button>
                        ${p.link ? `<a href="${p.link}" target="_blank" class="action-btn">üîó Code</a>` : ''}
                        <span class="tech-badge">${escapeHtml(p.tech || 'Tech')}</span>
                    </div>
                </div>
            `).join('');

            if (append) container.insertAdjacentHTML('beforeend', html);
            else container.innerHTML = html;

            document.getElementById('loadMoreContainer')?.remove();
            if (hasMoreProjects) container.insertAdjacentHTML('beforeend', `<div id="loadMoreContainer" style="text-align:center;padding:2rem;"><button onclick="loadMore()" class="btn btn-secondary">Load More</button></div>`);
        }

        function loadMore() { currentPage++; loadProjects(true); }

        async function loadSearchIndex() {
            try {
                const res = await fetch(`${SHEET_URL}?action=getSearchIndex`);
                const json = await res.json();
                if (json.status === 'success') {
                    searchIndex = json.data;
                    fuse = new Fuse(searchIndex, { keys: ['title', 'authorName', 'tech', 'category', 'description'], threshold: 0.3 });
                }
            } catch (e) {}
        }

        function handleSearch(term) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const container = document.getElementById('projectsList');
                const btn = document.getElementById('loadMoreContainer');
                if (!term) { currentSearchTerm = ''; if (btn) btn.style.display='block'; if(container.dataset.mode === 'search') { container.dataset.mode = 'feed'; loadProjects(false); } return; }
                
                container.dataset.mode = 'search'; if (btn) btn.style.display='none';
                if (!fuse) return;
                const results = fuse.search(term).map(r => r.item);
                
                container.innerHTML = results.length ? results.map(p => `
                    <div class="search-result-card" onclick="window.location.href='project.html?id=${p.id}'">
                        <div class="search-icon-placeholder">üöÄ</div>
                        <div style="flex:1;">
                            <div style="font-weight:700;color:var(--primary)">${escapeHtml(p.title)}</div>
                            <div style="font-size:0.85rem;color:#666">by ${escapeHtml(p.authorName)} ‚Ä¢ <span style="color:var(--accent)">${escapeHtml(p.category)}</span></div>
                        </div>
                    </div>`).join('') : '<div class="card" style="text-align:center;">No matching projects.</div>';
            }, 300);
        }

        function filterCategory(btn, cat) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            currentSearchTerm = (cat === 'All') ? '' : cat; loadProjects(false);
        }

        async function handlePostProject(e) {
            e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.textContent = 'Posting...'; btn.disabled = true;
            const file = document.getElementById('postImage').files[0]; let imgUrl = ''; if (file) imgUrl = await uploadImage(file);
            const p = { id: Date.now().toString(), authorName: currentUser.name, authorEmail: currentUser.email, authorPicture: currentUser.profilePicture, title: document.getElementById('postTitle').value, description: document.getElementById('postDesc').value, link: document.getElementById('postLink').value, tech: document.getElementById('postTech').value, category: document.getElementById('postCategory').value, projectImage: imgUrl };
            await postData('addProject', { data: p }); closeModal('project'); e.target.reset(); btn.textContent = 'Post'; btn.disabled = false; loadProjects(false);
        }

        async function handleEditProfile(e) {
            e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.textContent = 'Saving...'; btn.disabled = true;
            const f1 = document.getElementById('editPic').files[0], f2 = document.getElementById('editResumeFile').files[0];
            let pUrl = currentUser.profilePicture, rUrl = currentUser.resume || '';
            if (f1) pUrl = await uploadImage(f1); if (f2) rUrl = await uploadFile(f2);
            const u = { ...currentUser, name: document.getElementById('editName').value, university: document.getElementById('editUni').value, major: document.getElementById('editMajorInput').value, bio: document.getElementById('editBio').value, linkedin: document.getElementById('editLinked').value, github: document.getElementById('editGit').value, profilePicture: pUrl, resume: rUrl };
            await postData('updateProfile', { data: u }); currentUser = u; localStorage.setItem('studenthub_user', JSON.stringify(u)); closeModal('editProfile'); btn.textContent = 'Save'; btn.disabled = false; showApp();
        }

        function openMyProfile() { if (window.innerWidth <= 968) { document.getElementById('menuAvatar').src = currentUser.profilePicture || 'default-avatar.png'; document.getElementById('menuName').textContent = currentUser.name; openModal('userMenu'); } else openMyProfilePage(); }
        function openMyProfilePage() { window.location.href = `index.html?email=${currentUser.email}`; }
        async function upvote(id, btn) { const sp = btn.querySelector('span'); let c = parseInt(sp.textContent) || 0; btn.classList.toggle('active'); sp.textContent = btn.classList.contains('active') ? c + 1 : c - 1; await postData('toggleUpvote', { projectId: id, userEmail: currentUser.email }); }
        async function openComments(id) { currentCommentProjectId = id; openModal('comments'); document.getElementById('commentsList').innerHTML = '<p>Loading...</p>'; const res = await fetch(`${SHEET_URL}?action=getComments&projectId=${id}`); const json = await res.json(); document.getElementById('commentsList').innerHTML = json.data.map(c => `<div class="comment-item"><div class="comment-author">${escapeHtml(c.authorName)}</div><div class="comment-text">${escapeHtml(c.comment)}</div></div>`).join(''); }
        async function submitComment() { const t = document.getElementById('commentInput').value.trim(); if (!t) return; await postData('addComment', { data: { id: Date.now().toString(), projectId: currentCommentProjectId, authorName: currentUser.name, authorEmail: currentUser.email, comment: t } }); document.getElementById('commentInput').value = ''; openComments(currentCommentProjectId); }

        function escapeHtml(t) { return t ? t.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '' }
        function formatDate(t) { const d = new Date(t), n = new Date(); return Math.floor((n - d) / 86400000) < 7 ? Math.floor((n - d) / 86400000) + 'd ago' : d.toLocaleDateString(); }
        function closeModal(id) { document.getElementById(id + 'Modal').classList.remove('active') }
        function openModal(id) { document.getElementById(id + 'Modal').classList.add('active') }
        async function postData(a, p) { return fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ action: a, ...p }) }).then(r => r.json()) }
        async function uploadImage(f) { const d = new FormData(); d.append('file', f); d.append('upload_preset', CLOUDINARY_PRESET); return fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_NAME}/image/upload`, { method: 'POST', body: d }).then(r => r.json()).then(x => x.secure_url) }
        async function uploadFile(f) { const d = new FormData(); d.append('file', f); d.append('upload_preset', CLOUDINARY_PRESET); return fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_NAME}/auto/upload`, { method: 'POST', body: d }).then(r => r.json()).then(x => x.secure_url) }
        function shareProject(id, t) { document.getElementById('shareProjectLink').value = `${window.location.origin}${window.location.pathname.replace('feed.html', 'project.html')}?id=${id}`; openModal('shareProject'); }
        function copyShareLink() { const i = document.getElementById('shareProjectLink'); i.select(); document.execCommand('copy'); }
        function shareViaEmail() { window.open(`mailto:?subject=Check out this project&body=${encodeURIComponent(document.getElementById('shareProjectLink').value)}`) }
        function shareViaWhatsApp() { window.open(`whatsapp://send?text=${encodeURIComponent(document.getElementById('shareProjectLink').value)}`) }
        function shareViaTwitter() { window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(document.getElementById('shareProjectLink').value)}`) }
        function shareViaLinkedIn() { window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(document.getElementById('shareProjectLink').value)}`) }
    </script>
</body>

</html>
